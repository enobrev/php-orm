<?php
    namespace {{ namespace }};
{% if date_updated or date_added  %}

    use DateTime;
{% endif %}

    use Enobrev\ORM\Db;
    use Enobrev\ORM\Tables;
    use Enobrev\SQL;

    class {{table.plural}} extends Tables {
        /**
         * @return {{table.title}}
         */
        public static function getTable() {
            return new {{table.title}};
        }
{% if count.outbound %}
{% for field in fields %}
{% if field.reference %}

        /**
         * @param int|{{field.reference.subclass}} $i{{field.reference.subclass}}Id
         * @return {{table.plural}}
         * @throws \Enobrev\ORM\DbException
         * @throws \Enobrev\SQLMissingTableOrFieldsException
         */
        public static function getBy{{field.reference.title}}($i{{field.reference.subclass}}Id) {
            $oTable = static::getTable();
            $oSQL = SQL::select(
                $oTable,
                SQL::eq($oTable->{{field.name}}->setValue($i{{field.reference.subclass}}Id))
            );

            $oResults = Db::getInstance()->namedQuery([__CLASS__, __METHOD__], $oSQL);
            return self::fromResults($oResults, $oTable);
        }

        /**
         * @param {{ field.reference.subclass_plural }}|int[] $a{{ field.reference.subclass }}Ids
         * @return {{ table.plural }}
         * @throws \Enobrev\ORM\DbException
         * @throws \Enobrev\SQLMissingTableOrFieldsException
         */
        public static function getBy{{field.reference.title_plural}}($a{{ field.reference.subclass }}Ids) {
            if ($a{{ field.reference.subclass }}Ids instanceof {{field.reference.subclass_plural}}) {
                $a{{ field.reference.subclass }}Ids = $a{{ field.reference.subclass }}Ids->toPrimaryArray();
            }

            $oTable = static::getTable();
            $oSQL = SQL::select(
                $oTable,
                SQL::in($oTable->{{field.name}}, $a{{field.reference.subclass}}Ids)
            );

            $oResults = Db::getInstance()->namedQuery([__CLASS__, __METHOD__], $oSQL);
            return self::fromResults($oResults, $oTable);
        }
{% endif %}
{% endfor %}
{% endif %}

{% if date_updated or date_added  %}

        /**
         * @return DateTime
         * @throws \Enobrev\ORM\DbException
         * @throws \Enobrev\SQLMissingTableOrFieldsException
         */
{% if date_updated %}
        public static function getMostRecentUpdatedDate() {
{% else %}
        public static function getMostRecentAddedDate() {
{% endif %}
            $oTable = static::getTable();
            $oSQL = SQL::select(
{% if date_updated %}
                $oTable->{{ date_updated.name }},
                SQL::desc($oTable->{{ date_updated.name }}),
{% else %}
                $oTable->{{ date_added.name }},
                SQL::desc($oTable->{{ date_added.name }}),
{% endif %}
                SQL::limit(1)
            );

            $oResults = Db::getInstance()->namedQuery([__CLASS__, __METHOD__], $oSQL);
{% if date_updated %}
            return new DateTime($oResults->fetchObject()->{{ date_updated.name }});
{% else %}
            return new DateTime($oResults->fetchObject()->{{ date_added.name }});
{% endif %}
        }
{% endif %}
    }