<?php
    namespace {{ namespace }};

    use Enobrev\ORM\Table;
    use Enobrev\ORM\Field;

    class {{table.title}} extends Table {
        protected $sTitle = '{{table.name}}';

{% for field in fields %}
{% if field.type == 'Field\\Enum' %}
{% for value in field.values %}
        const {{value.const_padded}}= '{{value.name}}';
{% endfor %}

{% endif %}
{% endfor %}
{% for field in fields %}
        /** @var {{field.type}} {{field.name}} **/
        public ${{ field.name }};

{% endfor %}

        protected function init() {
{% if primary %}
{% for field in primary %}
            $this->addPrimary(new {{field.type}}('{{field.name}}'));
{% endfor %}
{% endif %}

            $this->addFields(
{% for field in fields %}
{% if field.primary == false %}
{% if field.type == 'Field\\Enum' %}
                new {{field.type}}('{{field.name}}', [{% for value in field.values %}self::{{value.const}}{% if not loop.last %}, {% endif %}{% endfor %}]){% if not loop.last %},{% endif %}

{% else %}
                new {{field.type}}('{{field.name}}'){% if not loop.last %},{% endif %}

{% endif %}
{% endif %}
{% endfor %}
            );

{% for field in fields %}
{% if field.default is not empty %}
            $this->{{field.name}}->setDefault({{field.default|raw}});
{% endif %}
{% endfor %}
        }

{% if primary %}
        /**
{% for field in primary %}
         * @param int ${{field.var}}
{% endfor %}
         * @return {{table.title}}
         */
        public static function getById({% for field in primary %}${{field.var}}{% if not loop.last %}, {% endif %}{% endfor %}) {
            $oTable = new self;
            return self::getBy(
{% for field in primary %}
{% if loop.last %}
                $oTable->{{field.name}}->setValue(${{field.var}})
{% else %}
                $oTable->{{field.name}}->setValue(${{field.var}}),
{% endif %}
{% endfor %}
            );
        }
{% endif %}

{% for field in fields %}
{% if field.reference %}
        /**
         * @return {{field.reference.class}}
         */
        public function get{{field.reference.title}}() {
            if ($this->{{field.name}}->hasValue()) {
                return {{field.reference.class}}::getById($this->{{field.name}}->getValue());
            }
        }

{% endif %}
{% endfor %}
{% if date_added or date_updated %}

        public function preInsert() {
{% if date_added %}
            $this->{{date_added.name}}->setValue($this->now());
{% endif %}
{% if date_updated %}
            $this->{{date_updated.name}}->setValue($this->now());
{% endif %}
        }

        public function preUpsert() {
{% if date_added %}
            $this->{{date_added.name}}->setValue($this->now());
{% endif %}
{% if date_updated %}
            $this->{{date_updated.name}}->setValue($this->now());
{% endif %}
        }
{% if date_updated %}

        public function preUpdate() {
{% if date_updated %}
            $this->{{date_updated.name}}->setValue($this->now());
{% endif %}
        }
{% endif %}
{% endif %}

        // ResponseHeadersTable

        public function getEtag() {
            return $this->toHash();
        }
{% if date_updated %}

        public function getLastModified() {
            return $this->{{date_updated.name}}->getValue();
        }
{% elseif date_added %}

        public function getLastModified() {
            return $this->{{date_added.name}}->getValue();
        }
{% endif %}
    }